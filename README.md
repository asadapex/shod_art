# Shod Art API

API для админ-панели с управлением пользователями, продуктами и изображениями.

## Исправления в проекте

### Основные исправления:

1. **Исправлена ошибка с созданием продуктов**
   - Проблема: `Column count doesn't match value count at row 1` при создании продукта с массивом изображений
   - Решение: Исправлена логика обработки `image_urls` в `ProductsService`
   - Теперь `image_urls` правильно сохраняется как массив в базе данных

2. **Улучшена обработка ошибок**
   - Добавлен глобальный `HttpExceptionFilter` для обработки всех типов исключений
   - Улучшена обработка ошибок TypeORM (QueryFailedError, EntityNotFoundError)
   - Добавлены специфические сообщения для ошибок MySQL

3. **Добавлена глобальная валидация**
   - Включен `ValidationPipe` с автоматической валидацией DTO
   - Whitelist режим для удаления лишних свойств
   - Автоматическое преобразование типов

4. **Улучшена система аутентификации**
   - Улучшена JWT стратегия с типизацией и лучшей обработкой ошибок
   - Добавлены проверки прав доступа в `CanEditProductsGuard`
   - Улучшена валидация пользователей

5. **Исправлена загрузка изображений**
   - Добавлена автоматическое создание папки `uploads`
   - Улучшена валидация файлов (тип, размер)
   - Добавлена обработка ошибок при загрузке

6. **Улучшены DTO**
   - Исправлены типы в `ProductResponseDto` (image_urls как массив)
   - Добавлены недостающие поля в `UpdateProductDto`
   - Улучшена документация Swagger

## Установка и запуск

### Требования
- Node.js 18+
- MySQL 8.0+
- npm или yarn

### Установка зависимостей
```bash
npm install
```

### Настройка базы данных
1. Создайте базу данных MySQL
2. Настройте переменные окружения в `.env` файле:

```env
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=your_username
DB_PASSWORD=your_password
DB_NAME=your_database
DB_SYNC=true
JWT_SECRET=your_jwt_secret
```

### Запуск в режиме разработки
```bash
npm run start:dev
```

### Запуск в продакшене
```bash
npm run build
npm run start:prod
```

## API Endpoints

### Аутентификация
- `POST /auth/login` - Вход в систему

### Пользователи
- `GET /users` - Получить всех пользователей
- `GET /users/:id` - Получить пользователя по ID
- `POST /users` - Создать пользователя
- `PUT /users/:id` - Обновить пользователя
- `DELETE /users/:id` - Удалить пользователя

### Продукты
- `GET /products` - Получить все продукты
- `GET /products/:id` - Получить продукт по ID
- `POST /products` - Создать продукт (требует аутентификации)
- `PUT /products/:id` - Обновить продукт (требует аутентификации)
- `DELETE /products/:id` - Удалить продукт (требует аутентификации)

### Изображения
- `POST /images/upload` - Загрузить одно изображение
- `POST /images/upload-multiple` - Загрузить несколько изображений
- `GET /images/:id` - Получить изображение по ID

## Swagger документация
Доступна по адресу: `http://localhost:3030/api`

## Структура проекта

```
src/
├── auth/                 # Аутентификация и авторизация
├── common/              # Общие компоненты (фильтры, интерцепторы)
├── images/              # Управление изображениями
├── products/            # Управление продуктами
├── users/               # Управление пользователями
├── app.module.ts        # Главный модуль
└── main.ts             # Точка входа
```

## Особенности

1. **Безопасность**
   - JWT аутентификация
   - Хеширование паролей с bcrypt
   - Валидация входных данных
   - Проверка прав доступа

2. **Обработка ошибок**
   - Глобальный обработчик исключений
   - Детальные сообщения об ошибках
   - Логирование ошибок

3. **Валидация**
   - Автоматическая валидация DTO
   - Проверка типов данных
   - Валидация файлов

4. **Документация**
   - Swagger/OpenAPI документация
   - Подробные описания endpoints
   - Примеры запросов и ответов

## Известные проблемы и их решения

1. **Ошибка "Column count doesn't match value count"**
   - **Причина**: Неправильная обработка массива изображений
   - **Решение**: Исправлена логика в `ProductsService.create()`

2. **Ошибка "User not found" при аутентификации**
   - **Причина**: Неправильная обработка пользователей в JWT стратегии
   - **Решение**: Улучшена логика в `JwtStrategy.validate()`

3. **Ошибка "File is required" при загрузке изображений**
   - **Причина**: Отсутствие валидации файлов
   - **Решение**: Добавлена валидация в `ImagesService.uploadFile()`

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь, что база данных доступна
3. Проверьте переменные окружения
4. Убедитесь, что все зависимости установлены
